version: '3.9'

services:
  # Master Nodes
  es-master1:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.10.2
    container_name: es-master1
    environment:
      - node.roles=master
      - cluster.name=elastic-cluster
      - node.name=es-master1
      - bootstrap.memory_lock=true
      - discovery.seed_hosts=es-master1,es-master2,es-master3
      - cluster.initial_master_nodes=es-master1,es-master2,es-master3
      - xpack.security.enabled=true
      - xpack.security.transport.ssl.enabled=true
      - xpack.security.transport.ssl.key=/usr/share/elasticsearch/config/certs/es-master1/es-master1.key
      - xpack.security.transport.ssl.certificate=/usr/share/elasticsearch/config/certs/es-master1/es-master1.crt
      - xpack.security.transport.ssl.certificate_authorities=/usr/share/elasticsearch/config/certs/ca/ca.crt
    volumes:
      - ./certs:/usr/share/elasticsearch/config/certs
    ports:
      - 9200:9200
      - 9300:9300
    ulimits:
      memlock:
        soft: -1
        hard: -1

  es-master2:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.10.2
    container_name: es-master2
    environment:
      - node.roles=master
      - cluster.name=elastic-cluster
      - node.name=es-master2
      - bootstrap.memory_lock=true
      - discovery.seed_hosts=es-master1,es-master2,es-master3
      - cluster.initial_master_nodes=es-master1,es-master2,es-master3
      - xpack.security.enabled=true
      - xpack.security.transport.ssl.enabled=true
      - xpack.security.transport.ssl.key=/usr/share/elasticsearch/config/certs/es-master2/es-master2.key
      - xpack.security.transport.ssl.certificate=/usr/share/elasticsearch/config/certs/es-master2/es-master2.crt
      - xpack.security.transport.ssl.certificate_authorities=/usr/share/elasticsearch/config/certs/ca/ca.crt
    volumes:
      - ./certs:/usr/share/elasticsearch/config/certs
    ports:
      - 9201:9200
      - 9301:9300
    ulimits:
      memlock:
        soft: -1
        hard: -1

  es-master3:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.10.2
    container_name: es-master3
    environment:
      - node.roles=master
      - cluster.name=elastic-cluster
      - node.name=es-master3
      - bootstrap.memory_lock=true
      - discovery.seed_hosts=es-master1,es-master2,es-master3
      - cluster.initial_master_nodes=es-master1,es-master2,es-master3
      - xpack.security.enabled=true
      - xpack.security.transport.ssl.enabled=true
      - xpack.security.transport.ssl.key=/usr/share/elasticsearch/config/certs/es-master3/es-master3.key
      - xpack.security.transport.ssl.certificate=/usr/share/elasticsearch/config/certs/es-master3/es-master3.crt
      - xpack.security.transport.ssl.certificate_authorities=/usr/share/elasticsearch/config/certs/ca/ca.crt
    volumes:
      - ./certs:/usr/share/elasticsearch/config/certs
    ports:
      - 9202:9200
      - 9302:9300
    ulimits:
      memlock:
        soft: -1
        hard: -1

  # Ingest/Data Nodes
  es-data1:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.10.2
    container_name: es-data1
    environment:
      - node.roles=data,ingest
      - cluster.name=elastic-cluster
      - node.name=es-data1
      - bootstrap.memory_lock=true
      - discovery.seed_hosts=es-master1,es-master2,es-master3
      - xpack.security.enabled=true
      - xpack.security.transport.ssl.enabled=true
      - xpack.security.transport.ssl.key=/usr/share/elasticsearch/config/certs/es-data1/es-data1.key
      - xpack.security.transport.ssl.certificate=/usr/share/elasticsearch/config/certs/es-data1/es-data1.crt
      - xpack.security.transport.ssl.certificate_authorities=/usr/share/elasticsearch/config/certs/ca/ca.crt
    volumes:
      - ./certs:/usr/share/elasticsearch/config/certs
    ports:
      - 9203:9200
      - 9303:9300
    ulimits:
      memlock:
        soft: -1
        hard: -1

  es-data2:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.10.2
    container_name: es-data2
    environment:
      - node.roles=data,ingest
      - cluster.name=elastic-cluster
      - node.name=es-data2
      - bootstrap.memory_lock=true
      - discovery.seed_hosts=es-master1,es-master2,es-master3
      - xpack.security.enabled=true
      - xpack.security.transport.ssl.enabled=true
      - xpack.security.transport.ssl.key=/usr/share/elasticsearch/config/certs/es-data2/es-data2.key
      - xpack.security.transport.ssl.certificate=/usr/share/elasticsearch/config/certs/es-data2/es-data2.crt
      - xpack.security.transport.ssl.certificate_authorities=/usr/share/elasticsearch/config/certs/ca/ca.crt
    volumes:
      - ./certs:/usr/share/elasticsearch/config/certs
    ports:
      - 9204:9200
      - 9304:9300
    ulimits:
      memlock:
        soft: -1
        hard: -1

  # Coordinating Nodes
  es-coord1:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.10.2
    container_name: es-coord1
    environment:
      - node.roles=[]
      - cluster.name=elastic-cluster
      - node.name=es-coord1
      - bootstrap.memory_lock=true
      - discovery.seed_hosts=es-master1,es-master2,es-master3
      - xpack.security.enabled=true
      - xpack.security.transport.ssl.enabled=true
      - xpack.security.transport.ssl.key=/usr/share/elasticsearch/config/certs/es-coord1/es-coord1.key
      - xpack.security.transport.ssl.certificate=/usr/share/elasticsearch/config/certs/es-coord1/es-coord1.crt
      - xpack.security.transport.ssl.certificate_authorities=/usr/share/elasticsearch/config/certs/ca/ca.crt
    volumes:
      - ./certs:/usr/share/elasticsearch/config/certs
    ports:
      - 9205:9200
      - 9305:9300
    ulimits:
      memlock:
        soft: -1
        hard: -1
